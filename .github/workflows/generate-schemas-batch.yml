name: Generate Schemas Batch

on:
  #TODO remove this
  push:
    branches: [main]
  schedule:
    - cron: '45 5 * * SUN'
  workflow_dispatch:
    inputs:
      api_specs_ref:
        description: 'Git ref or full SHA for https://github.com/Azure/azure-rest-api-specs.'
        required: true
        default: 'main'

env:
  # This must be kept in sync with the arguments passed to the "batch" matrix
  BATCH_COUNT: 100

jobs:
  generate:
    name: Update Schemas Batch ${{ matrix.batch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        #TODO update this + batch count
        batch: [0]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Clone azure-rest-api-specs
        uses: actions/checkout@v3
        with:
          repository: Azure/azure-rest-api-specs
          path: workflow-temp/azure-rest-api-specs
          ref: ${{ github.event.inputs.api_specs_ref }}
      
      - name: Install generator npm packages
        run: npm ci
        working-directory: generator

      - name: Run generator
        run: |
          rm -Rf "$GITHUB_WORKSPACE/schemas"
          rm -Rf "$GITHUB_WORKSPACE/summary.log"
          mkdir -p "$GITHUB_WORKSPACE/schemas"

          npm run generate-all -- \
            --local-path "$GITHUB_WORKSPACE/workflow-temp/azure-rest-api-specs" \
            --batch-count ${{ env.BATCH_COUNT }} \
            --batch-index ${{ matrix.batch }} \
            --summary-log-path "$GITHUB_WORKSPACE/summary.log" \
            --combine-batch-mode true
        working-directory: generator

      - name: Upload Schemas
        uses: actions/upload-artifact@v3
        with:
          name: batch-${{ matrix.batch }}-schemas
          path: schemas
          if-no-files-found: error

      - name: Upload summary log
        uses: actions/upload-artifact@v3
        with:
          name: batch-${{ matrix.batch }}-summary
          path: summary.log
          if-no-files-found: error

  combine:
    needs: generate
    name: Combine Schema Batches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download batch results
        uses: actions/download-artifact@v3
        with:
          path: workflow-temp
      
      - name: Install generator npm packages
        run: npm ci
        working-directory: generator

      - name: Combine batches
        #TODO replace batch count here
        run: |
          npm run combine-batches -- \
            --input-path "$GITHUB_WORKSPACE/workflow-temp" \
            --batch-count 1
        working-directory: generator

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: autogenerate
          branch-suffix: short-commit-hash
          delete-branch: true
          title: |
            Update Generated Schemas
          body:  |
            Update Generated Schemas
          commit-message: |
            Update Generated Schemas
          labels: autogenerate
          draft: false